<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®åº“è¯Šæ–­å·¥å…·</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1, h2 {
            color: #333;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        .data-table th, .data-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .data-table th {
            background-color: #f8f9fa;
        }
        pre {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” ç”Ÿäº§çœ‹æ¿ç³»ç»Ÿæ•°æ®åº“è¯Šæ–­å·¥å…·</h1>
        <div id="status">æ­£åœ¨æ£€æŸ¥æ•°æ®åº“çŠ¶æ€...</div>

        <div style="margin: 20px 0;">
            <button onclick="checkAll()">ğŸ”„ é‡æ–°æ£€æŸ¥</button>
            <button onclick="triggerMigration()">ğŸ”„ è§¦å‘æ•°æ®è¿ç§»</button>
            <button onclick="clearAllData()">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰æ•°æ®</button>
            <button onclick="exportData()">ğŸ“¤ å¯¼å‡ºæ•°æ®</button>
        </div>
    </div>

    <div class="container">
        <h2>ğŸ“Š æ•°æ®åº“çŠ¶æ€</h2>
        <div id="dbStatus"></div>
    </div>

    <div class="container">
        <h2>ğŸ“‹ ä»»åŠ¡æ•°æ®</h2>
        <div id="taskData"></div>
    </div>

    <div class="container">
        <h2>ğŸ‘¨â€ğŸ”§ å¸ˆå‚…æ•°æ®</h2>
        <div id="masterData"></div>
    </div>

    <div class="container">
        <h2>ğŸ”§ æ“ä½œæ—¥å¿—</h2>
        <div id="logs"></div>
    </div>

    <script>
        let logs = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            logs.push(`[${timestamp}] ${message}`);
            updateLogs();
            console.log(message);
        }

        function updateLogs() {
            const logsDiv = document.getElementById('logs');
            logsDiv.innerHTML = '<pre>' + logs.slice(-20).join('\n') + '</pre>';
        }

        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `<div class="${type}">${message}</div>`;
        }

        async function checkLocalStorage() {
            log('æ£€æŸ¥localStorageæ•°æ®...');

            // æ£€æŸ¥åŸå§‹ä»»åŠ¡æ•°æ®
            const tasks = JSON.parse(localStorage.getItem('kanban_tasks') || '[]');
            const settings = JSON.parse(localStorage.getItem('kanban_settings') || '{}');
            const masterAssignments = JSON.parse(localStorage.getItem('kanban_master_assignments') || '[]');
            const sqliteData = localStorage.getItem('sqlite_db_data');

            const dbStatusDiv = document.getElementById('dbStatus');
            dbStatusDiv.innerHTML = `
                <table class="data-table">
                    <tr><th>æ•°æ®ç±»å‹</th><th>æ•°é‡/çŠ¶æ€</th><th>å¤§å°</th></tr>
                    <tr><td>localStorageä»»åŠ¡</td><td>${tasks.length}</td><td>${JSON.stringify(tasks).length} å­—ç¬¦</td></tr>
                    <tr><td>localStorageè®¾ç½®</td><td>${Object.keys(settings).length}</td><td>${JSON.stringify(settings).length} å­—ç¬¦</td></tr>
                    <tr><td>å¸ˆå‚…åˆ†é…è®°å½•</td><td>${masterAssignments.length}</td><td>${JSON.stringify(masterAssignments).length} å­—ç¬¦</td></tr>
                    <tr><td>SQLiteæ•°æ®åº“</td><td>${sqliteData ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}</td><td>${sqliteData ? (sqliteData.length / 1024).toFixed(2) + ' KB' : '0 KB'}</td></tr>
                </table>
            `;

            // æ˜¾ç¤ºä»»åŠ¡æ•°æ®
            const taskDataDiv = document.getElementById('taskData');
            if (tasks.length > 0) {
                const taskTable = tasks.slice(0, 10).map(task =>
                    `<tr><td>${task.id}</td><td>${task.productName}</td><td>${task.masterName}</td><td>${task.status}</td></tr>`
                ).join('');
                taskDataDiv.innerHTML = `
                    <p>æ‰¾åˆ° ${tasks.length} ä¸ªä»»åŠ¡ï¼ˆæ˜¾ç¤ºå‰10ä¸ªï¼‰ï¼š</p>
                    <table class="data-table">
                        <tr><th>ID</th><th>äº§å“åç§°</th><th>å¸ˆå‚…</th><th>çŠ¶æ€</th></tr>
                        ${taskTable}
                    </table>
                `;
            } else {
                taskDataDiv.innerHTML = '<div class="warning">æ²¡æœ‰æ‰¾åˆ°localStorageä¸­çš„ä»»åŠ¡æ•°æ®</div>';
            }

            // æ˜¾ç¤ºå¸ˆå‚…æ•°æ®
            const masterDataDiv = document.getElementById('masterData');
            if (masterAssignments.length > 0) {
                const masterTable = masterAssignments.slice(0, 10).map(assignment =>
                    `<tr><td>${assignment.productName}</td><td>${assignment.masterName}</td><td>${assignment.confidence || 'N/A'}</td></tr>`
                ).join('');
                masterDataDiv.innerHTML = `
                    <p>æ‰¾åˆ° ${masterAssignments.length} ä¸ªå¸ˆå‚…åˆ†é…è®°å½•ï¼ˆæ˜¾ç¤ºå‰10ä¸ªï¼‰ï¼š</p>
                    <table class="data-table">
                        <tr><th>äº§å“åç§°</th><th>å¸ˆå‚…</th><th>ç½®ä¿¡åº¦</th></tr>
                        ${masterTable}
                    </table>
                `;
            } else {
                masterDataDiv.innerHTML = '<div class="warning">æ²¡æœ‰æ‰¾åˆ°å¸ˆå‚…åˆ†é…è®°å½•</div>';
            }

            return {
                hasLocalStorageTasks: tasks.length > 0,
                hasSQLiteData: !!sqliteData,
                taskCount: tasks.length,
                tasks: tasks
            };
        }

        async function triggerMigration() {
            log('å¼€å§‹æ‰‹åŠ¨è§¦å‘æ•°æ®è¿ç§»...');
            showStatus('æ­£åœ¨è§¦å‘æ•°æ®è¿ç§»...', 'info');

            try {
                // è¿™é‡Œéœ€è¦è°ƒç”¨å®é™…çš„è¿ç§»å‡½æ•°
                // ç”±äºæˆ‘ä»¬åœ¨è¯Šæ–­é¡µé¢ï¼Œéœ€è¦é‡æ–°åŠ è½½ä¸»åº”ç”¨çš„è¿ç§»é€»è¾‘
                showStatus('æ•°æ®è¿ç§»éœ€è¦åœ¨ä¸»åº”ç”¨ä¸­æ‰§è¡Œï¼Œè¯·è¿”å›ä¸»é¡µé¢å¹¶åˆ·æ–°', 'warning');
                log('è¯·è¿”å›ä¸»åº”ç”¨é¡µé¢ï¼ˆhttp://localhost:3001ï¼‰å¹¶åˆ·æ–°é¡µé¢ä»¥è§¦å‘è‡ªåŠ¨è¿ç§»');
            } catch (error) {
                log('è¿ç§»å¤±è´¥: ' + error.message);
                showStatus('è¿ç§»å¤±è´¥: ' + error.message, 'error');
            }
        }

        async function clearAllData() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æ•°æ®å—ï¼Ÿè¿™ä¸ªæ“ä½œä¸å¯é€†ï¼')) {
                log('æ¸…é™¤æ‰€æœ‰æ•°æ®...');
                localStorage.removeItem('kanban_tasks');
                localStorage.removeItem('kanban_settings');
                localStorage.removeItem('kanban_master_assignments');
                localStorage.removeItem('kanban_import_settings');
                localStorage.removeItem('sqlite_db_data');

                // æ¸…é™¤æ‰€æœ‰ä»¥ kanban_ å¼€å¤´çš„é¡¹ç›®
                Object.keys(localStorage).forEach(key => {
                    if (key.startsWith('kanban_') || key.startsWith('sqlite_') || key.startsWith('localStorage_backup_')) {
                        localStorage.removeItem(key);
                    }
                });

                showStatus('æ‰€æœ‰æ•°æ®å·²æ¸…é™¤', 'success');
                log('æ‰€æœ‰æ•°æ®å·²æ¸…é™¤');
                await checkAll();
            }
        }

        async function exportData() {
            log('å¯¼å‡ºæ•°æ®...');
            const data = await checkLocalStorage();

            const exportData = {
                timestamp: new Date().toISOString(),
                localStorage: {
                    tasks: JSON.parse(localStorage.getItem('kanban_tasks') || '[]'),
                    settings: JSON.parse(localStorage.getItem('kanban_settings') || '{}'),
                    masterAssignments: JSON.parse(localStorage.getItem('kanban_master_assignments') || '[]'),
                    importSettings: JSON.parse(localStorage.getItem('kanban_import_settings') || '{}')
                },
                sqliteData: localStorage.getItem('sqlite_db_data') ? 'exists' : 'not_exists'
            };

            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `kanban_data_export_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);

            log('æ•°æ®å¯¼å‡ºå®Œæˆ');
        }

        async function checkAll() {
            log('å¼€å§‹å…¨é¢æ£€æŸ¥...');
            showStatus('æ­£åœ¨æ£€æŸ¥æ•°æ®åº“çŠ¶æ€...', 'info');

            const result = await checkLocalStorage();

            if (result.hasLocalStorageTasks && !result.hasSQLiteData) {
                showStatus('å‘ç°localStorageä¸­æœ‰ä»»åŠ¡æ•°æ®ï¼Œä½†SQLiteæ•°æ®åº“ä¸ºç©ºã€‚å»ºè®®è§¦å‘æ•°æ®è¿ç§»ã€‚', 'warning');
            } else if (!result.hasLocalStorageTasks && result.hasSQLiteData) {
                showStatus('SQLiteæ•°æ®åº“å­˜åœ¨ï¼Œä½†localStorageä¸­æ²¡æœ‰ä»»åŠ¡æ•°æ®ã€‚æ•°æ®å¯èƒ½å·²è¿ç§»ã€‚', 'success');
            } else if (result.hasLocalStorageTasks && result.hasSQLiteData) {
                showStatus('localStorageå’ŒSQLiteéƒ½æœ‰æ•°æ®ï¼Œè¯·æ£€æŸ¥æ•°æ®åŒæ­¥çŠ¶æ€ã€‚', 'info');
            } else {
                showStatus('æ²¡æœ‰æ‰¾åˆ°ä»»ä½•ä»»åŠ¡æ•°æ®ã€‚', 'error');
            }

            log('æ£€æŸ¥å®Œæˆ');
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
        window.addEventListener('load', checkAll);
    </script>
</body>
</html>
